<!DOCTYPE html>
<html>
<head>
    <title>Iterations</title>

    <script type="text/javascript" src="/apps/2.0p/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define('Iterations', {
                extend: 'Rally.app.App',
                componentCls: 'app',
            
                launch: function() {
                	this.buildReleaseComboBox();
                },
            
                buildTree: function(){
            
            	if(this.tree){
            	    this.tree.destroy();
            	}
            
            	var selectedRelease = this.combobox.getRecord();
            
            	this.tree = Ext.widget('rallytree', {
            	    topLevelModel: 'Iteration',
            
            	    topLevelStoreConfig: {
            		filters: [
            		    {
            		        property: 'StartDate',
            		        value: selectedRelease.raw.ReleaseStartDate,
            		        operator: '>='
            		   },
            		   {
            		        property: 'EndDate',
            		        value: selectedRelease.raw.ReleaseDate,
            		        operator: '<='
            		   }
            		],
            		sorters: []
            	    },
            
            	    childModelTypeForRecordFn: function(record){
            	    	return 'UserStory';
                        	
                   	    },
                        parentAttributeForChildRecordFn: function(record){
                            return 'Iteration';
                        },
                        canExpandFn: function(record){
            	    	if(record.get('_type') === 'iteration'){
            		    return true;
            		}
                        	
                        }
            	    
            	});
            
            	this.add(this.tree);
                },
            
                buildReleaseComboBox: function(){
            	this.combobox = Ext.widget('rallyreleasecombobox', {
            
            	   storeConfig: {
            		sorters: [{
            		  property: 'ReleaseStartDate',
            		  direction: 'asc'
            	         }]
            	    },
            
            	    listeners: {
            		ready: this.buildTree,
            		select: this.buildTree,
            		scope: this
            	    }
            	});
            
            	this.add(this.combobox);
                }
            
            });

            Rally.launchApp('Iterations', {
                name: 'Iterations'
            });
        });
    </script>

    <style type="text/css">
        .app {
             /* Add app styles here */
        }
    </style>
</head>
<body></body>
</html>
